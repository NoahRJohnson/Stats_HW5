---
title: "Homework 5"
author: "Statistical Inference 1"
date: "11/22/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Guidelines

+ This is a group project. You may work in groups with up to 6 people. You only need to turn in one homework assignment for each group, but make sure that everyone’s name is listed on the assignment. 
+ Also, even if you don’t write the code for every part of the assignment, you should practice the skills in each section.
+ This assignment focuses on simulating data that violates various assumptions of the linear regression model.
+ Some sample code has been included, but you will need to try many different starting values for the parameters, sample size, and distributional assumptions. The included code is just to give you a starting point; it should not be considered sufficient to answer all the questions in each part. (And you are welcome to ignore the sample code and use your own)

# Questions

1.	Nonlinear relationship
    a.	Simulate data for a variety of different non-linear relationships (e.g. polynomial, exponential, sinusoidal).
    
    ```{r}
    polynomial <- function(x) {
      return (x^2)
    }
    exponential <- function(x) {
      return (exp(x))
    }
    sinusoidal <- function(x) {
      return (sin(x))
    }
    Fs <- c(polynomial, exponential, sinusoidal)
    ``` 
    
    b.	Try simulations with a small sample size (e.g. 20), a medium sample size (e.g. n= 100), and a large sample size (e.g. n = 5000).
    c.	For each simulation, 
        i.	Predict y-hat at several different locations using a confidence interval.
        ii.	Predict the beta coefficients for a linear model using a confidence interval.
        iii. Find the MSE (to estimate sigma^2)
        iv. Test to see whether the beta(s) are significant
    
    ```{r}
    Ns <- c(20,100,5000) # small, medium, large
    x_lim.lower <- -10
    x_lim.upper <- 10
    noise.mean <- 0
    noise.sds <- c(10, 500, 1.5)
    
    sample_x.list <- c()
    sample_y.list <- c()
    
    y_hat.locations <- data.frame(sample_x = base::sample(x_lim.lower:x_lim.upper, size = 4, replace = FALSE)) # Use same variable name as predictor in lm
    
    for (i in 1:length(Fs)) {
      f <- Fs[[i]]
      noise.sd <- noise.sds[i]
      print("")
      print("NEW FUNCTION")
      
      for (j in 1:length(Ns)) {
        N <- Ns[j]
        print("")
        print(sprintf("N = %d", N))
        
        sample_x <- runif(n = N, min = x_lim.lower, max = x_lim.upper)
        sample_y <- f(sample_x) + rnorm(N, mean = noise.mean, sd = noise.sd)
      
        # Calculate model
        sim.lm <- lm(sample_y ~ sample_x)
        
        # Grab OLS coefficients
        intercept.estimate <- sim.lm$coefficients[1]
        beta1.estimate <- sim.lm$coefficients[2]
        
        # Plot regression line through data
        plot(sample_x, sample_y)
        abline(intercept.estimate, beta1.estimate, lwd = 5, col = "red")
        
        # Part (i)
        print("Prediction at:")
        print(y_hat.locations$sample_x)
        print(" is ")
        print(predict.lm(sim.lm, y_hat.locations, interval = "prediction"))
        
        # Part (ii)
        print("Confidence interval of coefficients:")
        print(confint(sim.lm, c("(Intercept)", "sample_x"), level = 0.95))
        
        # Part (iii)
        s <- summary(sim.lm)
        residuals <- s$residuals
        mse <- mean(residuals^2)
        print(sprintf("MSE: %f", mse))
      
        # Part (iv)
        p.prime <- 2
        n <- length(sample_x)
        res.df <- n - p.prime
        alpha <- 0.05
        
        
        intercept.se <- s$coefficients[1,2]
        intercept.t.val <- (intercept.estimate - 0) / intercept.se 
        #intercept.t.val <- s$coefficients[1,3]
        intercept.p.val <- 2 * pt(abs(intercept.t.val), res.df, lower.tail = FALSE)
        #intercept.p.val <- s$coefficients[1,4]
        if (intercept.p.val < alpha) {
          print(sprintf("Intercept IS significant at the %.3f level", alpha))
        } else {
          print(sprintf("Intercept IS NOT significant at the %.3f level", alpha))
        }
        
        
        beta1.se <- s$coefficients[2,2]
        beta1.t.val <- (beta1.estimate - 0) / beta1.se 
        #beta1.t.val <- s$coefficients[2,3]
        beta1.p.val <- 2 * pt(abs(beta1.t.val), res.df, lower.tail = FALSE)
        #beta1.p.val <- s$coefficients[2,4]
        if (beta1.p.val < alpha) {
          print(sprintf("Slope IS significant at the %.3f level", alpha))
        } else {
          print(sprintf("Slope IS NOT significant at the %.3f level", alpha))
        }
      }
    }
    
    ```

    d. Which of the above tasks were affected by the nonlinear relationship?
    
    #All of the above tasks are do-able with any type of data, no matter what relationship if any the predictor and response variables have. 
    
    
    e. After you have experimented with the effects of different model structures, true parameter values, and sample sizes, let's repeat the simulation but test yourself to see whether you can detect non-linearity.
        i. Have R randomly choose whether to simulate data from a true linear model or a true nonlinear model.
        ii. Simulate data accordingly and display informal/ formal diagnostics as appropriate.
        iii. Based on the diagnostics, predict whether the problem areas you mentioned in part d will be affected or not. (Note: You are not predicting whether the assumptions are violated -- just whether they are violated to such an extent that your ability to use the model is compromised)

    ```{r}
    
    ```

__Aside:__ Many of the issues you end up facing with a nonlinear relationship can also be seen if an important predictor is excluded from the model. If you have extra time, feel free to play with this issue as well (optional).

2.	Non-normal errors
    a.	Simulate errors from a variety of different non-normal distributions (e.g. gamma, poisson). Make sure to shift the errors over so that they are still centered at 0.
    b.	Try simulations with a small sample size (e.g. 20), a medium sample size (e.g. n= 100), and a large sample size (e.g. n = 5000). 
    c.	For each simulation, 
        i.	Predict y-hat at several different locations using a confidence interval.
        ii.	Predict the beta coefficients for a linear model using a confidence interval. 
        iii. Find the MSE (to estimate sigma^2)
        iv. Test to see whether the beta(s) are significant (t-tests)
    d. Which of the above tasks were affected by the violation of assumptions?
    e. After you have experimented with the effects of different model structures, true parameter values, and sample sizes, let's repeat the simulation but test yourself to see whether you can detect non-normality.
        i. Have R randomly choose whether to simulate data with normal or nonnormal errors
        ii. Simulate data accordingly and display informal/ formal diagnostics as appropriate.
        iii. Based on the diagnostics, predict whether the problem areas you mentioned in part d will be affected or not. (Note: You are not predicting whether the assumptions are violated-- just whether they are violated to such an extent that your ability to use the model is compromised)

```{r}
# Sample code to get started
n <- 200
b0 <- 10
b1 <- 2
eps_alpha <- 2
eps_beta <- 1/4


x <- runif(n, 0, 10)
eps <- (rgamma(n, eps_alpha, 1/eps_beta) - eps_alpha * eps_beta) * 2
y <- b0 - b1 * x + eps

hist(eps)
var(eps)
mean(eps)

```
        
3. Heterogeneous Variances
    a.	Simulate errors from a variety of different relationships with X (e.g. eps = 2 * sqrt(x))
    b.	Try simulations with a small sample size (e.g. 20), a medium sample size (e.g. n= 100), and a large sample size (e.g. n = 5000). 
    c.	For each simulation, 
        i.	Predict y-hat at several different locations using a confidence interval.
        ii.	Predict the beta coefficients for a linear model using a confidence interval. 
        iii. Find the MSE (to estimate sigma^2-- does that even make sense here?)
        iv. Test to see whether the beta(s) are significant (t-tests)
    d. Which of the above tasks were affected by the violation of assumptions?
    e. After you have experimented with the effects of different model structures, true parameter values, and sample sizes, let's repeat the simulation but test yourself to see whether you can detect heteroskedacity.
        i. Have R randomly choose whether to simulate errors with constant or non-constant variance
        ii. Simulate data accordingly and display informal/ formal diagnostics as appropriate.
        iii. Based on the diagnostics, predict whether the problem areas you mentioned in part d will be affected or not. (Note: You are not predicting whether the assumptions are violated-- just whether they are violated to such an extent that your ability to use the model is compromised)
        
```{r}
# Sample code to get started
n <- 200
b0 <- 10
b1 <- 10

x <- runif(n, 0, 10)
eps <- rnorm(n, sd = 0.5 * x^2)
y <- b0 + b1 * x + eps

```


4. Correlated Errors
    a.	Simulate errors from a variety of different correlation structures.
    b.	Try simulations with a small sample size (e.g. 20), a medium sample size (e.g. n= 100), and a large sample size (e.g. n = 5000). 
    c.	For each simulation, 
        i.	Predict y-hat at several different locations using a confidence interval.
        ii.	Predict the beta coefficients for a linear model using a confidence interval. 
        iii. Find the MSE (to estimate sigma^2)
        iv. Test to see whether the beta(s) are significant (t-tests)
    d. Which of the above tasks were affected by the violation of assumptions?
    e. After you have experimented with the effects of different model structures, true parameter values, and sample sizes, let's repeat the simulation but test yourself to see whether you can detect correlated errors.
        i. Have R randomly choose whether to simulate data with correlated or uncorrelated errors.
        ii. Simulate data accordingly and display informal/ formal diagnostics as appropriate.
        iii. Based on the diagnostics, predict whether the problem areas you mentioned in part d will be affected or not. (Note: You are not predicting whether the assumptions are violated-- just whether they are violated to such an extent that your ability to use the model is compromised)

```{r}
# Sample code to get started
n <- 200
b0 <- 10
b1 <- 10
rho <- 0.9
sigma <- 2

x <- runif(n, 0, 10)

eps <- arima.sim(model = list(ar = rho), n = n)

y <- b0 + b1 * x + eps

# OR...

eps <- rep(0, n)
e.ind <- rnorm(n, mean = 0, sd = (sigma / sqrt(1-rho^2)))
eps[1] <- e.ind[1]
for (i in 2:n) {
  eps[i] <- rho * eps[i-1] + e.ind[i]
}

y <- b0 + b1 * x + eps
```
        
5. Multicollinearity
    a.	Simulate predictors that are correlated with a variety of different correlation structures
    b.	Try simulations with a small sample size (e.g. 20), a medium sample size (e.g. n= 100), and a large sample size (e.g. n = 5000). 
    c.	For each simulation, 
        i.	Predict y-hat at several different locations using a confidence interval.
        ii.	Predict the beta coefficients for a linear model using a confidence interval. 
        iii. Find the MSE (to estimate sigma^2)
        iv. Test to see whether the beta(s) are significant (t-tests)
    d. Which of the above tasks were affected by the violation of assumptions?
    e. After you have experimented with the effects of different model structures, true parameter values, and sample sizes, let's repeat the simulation but test yourself to see whether you can detect collinearity.
        i. Have R randomly choose whether to simulate data with correlated or uncorrelated predictor variables (X).
        ii. Simulate data accordingly and display informal/ formal diagnostics as appropriate.
        iii. Based on the diagnostics, predict whether the problem areas you mentioned in part d will be affected or not. (Note: You are not predicting whether the assumptions are violated-- just whether they are violated to such an extent that your ability to use the model is compromised)

```{r}
n <- 20
b0 <- 10
b1 <- 3
b2 <- 7

simga <- 2

x1 <- runif(n, 0, 10)
x2 <- x1 + rnorm(n)
cor(x1, x2)


eps <- rnorm(n, sd = sigma)
y <- b0 + b1 * x1 + b2 * x2 + eps
```

        
6. Put it all together: Combine the code from the previous 5 parts. Have R randomly choose whether to generate data that violates one (or more) of the assumptions, or whether all the assumptions are valid. Show appropriate diagnostics and test yourself to see if you can predict whether there are problem areas or not. Repeat the simulation several times and record your accuracy at detecting the different problem areas.